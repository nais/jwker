# Jwker
An operator that updates [TokenDings](https://github.com/nais/token-exchange) based on the custom resource `nais.io/Jwker`.

The `Jwker` spec contains accesspolicies from `nais.io/Application` and a unique secret name for inceting a private JWKS to the application's container.

Applications use the private JWKS when they request `access_tokens` for other applications from TokenDings.

## Functionality
1. When an Application is generated or updated in a cluster, Naiserator will create a new `Jwker` resource with a new unique secret name.
1. The Jwker operator reads the `Jwker` and generates a jwks for the application. 
    1. If it is a new `Jwker`, a JWK is generated and its public key is added to a JWKS.
    1. If the `Jwker` is updated, a new JWK is generated and its public key is added to the JWKS along with the previous public JWK (fetched from storage). This ensures currently running applications remain functional during a rotating update.
1. The private JWKS is stored as a kubernetes secret using the name generated by Naiserator and mounted in to the application container.
1. The public JWKS is registered with TokenDings, along with the AccessPolicy from the `Jwker` spec.
    1. Each application is registered with a unique identifier in the form of `clustername:namespace:application` 

## Development
Deploy to your local cluster using

`make install && make deploy && make run`

A mock of the token-dings endpoint is available here:
https://github.com/nais/token-exchange